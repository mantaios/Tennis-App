<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <title>Ζωντανός Αγώνας Τένις - Διορθωμένο</title>
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
    }

    #tournamentInfo {
      text-align: center;
      margin-bottom: 30px;
    }

    #courtImage {
      width: 90%;
      max-width: 800px;
      height: 400px;
      margin: 0 auto;
      border-radius: 20px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 0 20px #000;
    }

    .scoreboard {
      display: inline-block;
      background: white;
      border-radius: 16px;
      padding: 20px 0 20px 20px;
      box-shadow: 0 0 16px #000;
      font-family: Arial, sans-serif;
      width: auto;
      max-width: 850px;
      margin: 50px auto 0;
      font-size: 1.5rem;
      margin-left: 5%;
      padding-right: 50px;
    }

    .scores-wrapper {
      display: flex;
      align-items: center;
      gap: 0;
      width: calc(var(--numSets) * 42px + 70px + 12px);
      min-width: fit-content;
    }

    .scoreboard-row {
      display: flex;
      align-items: center;
      margin: 12px 24px;
      justify-content: flex-start;
      gap: 0;
      position: relative;
    }

    .player-name {
      background-color: #006400;
      color: white;
      padding: 14px 22px;
      min-width: 200px;
      position: relative;
      font-weight: bold;
      font-size: 1.6rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 250px;
      margin-right: 8px;
    }

    .sets-container {
      display: flex;
      gap: 0;
      flex-grow: 0;
      justify-content: flex-start;
      margin-right: 8px;
    }

    .set-score {
      background-color: #4b0082;
      color: white;
      padding: 14px 18px;
      border-radius: 8px 0 0 8px;
      font-size: 1.6rem;
      min-width: 42px;
      text-align: center;
      border-right: 1px solid #fff;
    }

    .set-score:last-child {
      border-radius: 0 8px 8px 0;
      border-right: none;
    }

    .game-score-container {
      display: flex;
      align-items: center;
      min-width: 70px;
      justify-content: flex-start;
      color: #006400;
      font-weight: bold;
      font-size: 1.8rem;
      margin-right: 12px;
      position: relative;
    }

    .game-score {
      min-width: 42px;
      text-align: center;
    }

    #serveButton {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 2rem;
      color: #006400;
      user-select: none;
      width: 28px;
      height: 28px;
      line-height: 28px;
      text-align: center;
      padding: 0;
      margin-left: 10px;
    }

 /* 🔙 Κουμπί Πίσω στην Αρχική */
.back-button {
  position: fixed;
  top: 20px;
  left: 20px;
  background: linear-gradient(145deg, #05ee10, #008000);
  color: #121212;
  border: none;
  border-radius: 50px;
  padding: 12px 22px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(5,238,16,0.6);
  transition: all 0.3s ease;
  z-index: 1000;
}

.back-button:hover {
  background: linear-gradient(145deg, #05ee10, #32cd32);
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(5,238,16,0.8);
}

.back-button:active {
  transform: scale(0.95);
}

/* 📊 Κουμπί Στατιστικών */
#statsButton {
  position: fixed;
  top: 20px;
  right: 20px;
   background: linear-gradient(145deg, #05ee10, #008000);
  color: #121212;
  border: none;
  border-radius: 50px;
  padding: 12px 22px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(5,238,16,0.6);
  transition: all 0.3s ease;
  z-index: 1000;
}
#statsButton:hover {
 background: linear-gradient(145deg, #05ee10, #32cd32);
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(5,238,16,0.8);
}

#statsButton:active {
  transform: scale(0.95);
}

    .dual-action-container {
      display: flex;
      justify-content: space-between;
      margin: 40px auto 0;
      max-width: 850px;
      padding: 0 20px;
      gap: 20px;
    }

    .player-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      background-color: #1f1f1f;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
      height: 100%;
      min-height: 600px;
      color: #000;
      
    }

    .button-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
      flex-grow: 1;
      justify-content: space-evenly;
    }
.button-container .action-btn {
  background: linear-gradient(145deg, #05ee10, #008000);
  color: #121212;
  border: none;
  border-radius: 20px; /* λίγο πιο στρογγυλά αλλά όχι pill */
  cursor: pointer;
  font-size: 1.6rem;
  font-weight: bold;
  width: 100%;              /* 👈 γεμίζει το column */
  flex-grow: 1;             /* 👈 προσαρμόζεται στο ύψος */
  padding: 20px;            /* μεγάλο padding για γεμάτο κουμπί */
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(5,238,16,0.6);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.button-container .action-btn:hover {
  background: linear-gradient(145deg, #05ee10, #32cd32);
  transform: scale(1.03);
  box-shadow: 0 6px 16px rgba(5,238,16,0.8);
}

.button-container .action-btn:active {
  transform: scale(0.97);
  box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
}


    .serve-ball {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      margin-left: 4px;
    }
    
/* Διατηρούμε το υπάρχον στυλ */
.game-history {
    margin: 30px auto;
    padding: 20px;
    border: 2px solid #1f1f1f;
    border-radius: 16px;
    background: #1a1a1a;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    box-shadow: 0 0 12px rgba(0,0,0,0.6);
    max-width: 850px;
}

.game-history h3 {
    margin-bottom: 16px;
    font-size: 1.5em;
    color: #05ee10;
    text-align: center;
    font-weight: 600;
    letter-spacing: 1px;
}

.set-history {
    margin-bottom: 18px;
    padding: 14px;
    border-left: 4px solid #4b0082;
    background-color: #242424;
    border-radius: 10px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.set-history:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 12px rgba(75,0,130,0.4);
}

.set-history strong {
    display: block;
    margin-bottom: 10px;
    font-size: 1.1em;
    color: #ffffff;
}

.games-container {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.3s ease;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.game-score-history {
    flex: 0 0 auto;
    margin: 3px;
    padding: 8px 12px;
    background: #006400;
    border-radius: 8px;
    font-weight: bold;
    color: #fff;
    transition: background-color 0.2s, transform 0.2s;
    cursor: default;
    font-size: 0.95em;
}

.game-score-history:hover {
    background: #05ee10;
    color: #121212;
    transform: scale(1.08);
}

.toggle-button {
    width: 100%;
    padding: 6px 0;
    background: #4b0082;
    color: #fff;
    border: none;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s, transform 0.2s;
}

.toggle-button:hover {
    background: #6a0dad;
    transform: scale(1.02);
}

/* Responsive */
@media (max-width: 480px) {
    .game-score-history {
        flex: 1 1 100%;
        text-align: center;
        font-size: 0.85em;
    }
}

.player-name-wrapper h3 {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: #05ee10;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 20px;
    text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    transition: color 0.3s, transform 0.3s;
}

.player-name-wrapper h3:hover {
    color: #32cd32;
    transform: scale(1.05);
    cursor: default;
}
/* 📊 Κουμπί Στατιστικών & Save Match - κοινό στυλ */
.stats-save-button {
  position: fixed;
  top: 20px;
  background: linear-gradient(145deg, #ee4705, #008000);
  color: #121212;
  border: none;
  border-radius: 50px;
  padding: 12px 22px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(5,238,16,0.6);
  transition: all 0.3s ease;
  z-index: 1000;
}

.stats-save-button:hover {
  background: linear-gradient(145deg, #05ee10, #32cd32);
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(5,238,16,0.8);
}

.stats-save-button:active {
  transform: scale(0.95);
}

/* Ξεχωριστή τοποθέτηση δεξιά ή αριστερά */
#statsButton {
  right: 20px;
}

#saveMatchButton {
  right: 160px;
}

/* Όταν είναι ενεργό (πρώτο fault) */
.fault-active {
  background: linear-gradient(145deg, #ff0000, #cc0000) !important;
  color: #ffffff !important;
  box-shadow: 0 4px 12px rgba(255,0,0,0.6) !important;
  transform: scale(1.02) !important;
}
.fault-active:hover {
  background: linear-gradient(145deg, #ff4d4d, #ff0000) !important;
  transform: scale(1.05) !important;
}
.fault-active:active {
  background: linear-gradient(145deg, #990000, #cc0000) !important;
  transform: scale(0.97) !important;
  box-shadow: inset 0 3px 6px rgba(0,0,0,0.4) !important;
}
#saveMatchButton {
  position: fixed;
  top: 20px;
  right: 160px; /* 👉 το φέρνει δίπλα στο Stats button */
  background: linear-gradient(145deg, #05ee10, #008000);
  color: #121212;
  border: none;
  border-radius: 50px;
  padding: 12px 22px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(5,238,16,0.6);
  transition: all 0.3s ease;
  z-index: 1000;
}

#saveMatchButton:hover {
  background: linear-gradient(145deg, #05ee10, #32cd32);
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(5,238,16,0.8);
}

#saveMatchButton:active {
  transform: scale(0.95);
}

    
</style>
</head>
<body>
<a href="pregame.html" class="back-button">⬅ Πίσω στην αρχική</a>
  <div id="tournamentInfo"></div>
  <div id="courtImage"></div>
  <div id="wimbledonScoreboard" class="scoreboard"></div>

  <div id="actionButtonsContainer" class="dual-action-container">
      <div class="player-column" id="player1-column">
        <div class="player-name-wrapper">
          <h3 id="player1-name">ΠΑΙΚΤΗΣ 1</h3>
        </div>
        <div class="button-container" id="player1-buttons"></div>
      </div>

      <div class="player-column" id="player2-column">
        <div class="player-name-wrapper">
          <h3 id="player2-name">ΠΑΙΚΤΗΣ 2</h3>
        </div>
        <div class="button-container" id="player2-buttons"></div>
      </div>
  </div>

  <!-- 📌 Game History κάτω από τις player-columns -->
  <div id="gameHistory" class="game-history">
    <h3>Ιστορικό Game</h3>
  </div>

  <button id="statsButton">Στατιστικά</button>
<button id="saveMatchButton"> Αποθήκευση </button>

<script>
document.getElementById('statsButton').addEventListener('click', () => {
    window.location.href = 'stats.html';
});

function updateCourtImage(type) {
    const court = document.getElementById('courtImage');
    if (type === 'blue') {
      court.style.backgroundImage = 'url("hard.jpg")';
    } else if (type === 'clay') {
      court.style.backgroundImage = 'url("clay.jpg")';
    } else {
      court.style.backgroundImage = 'url("grass.jpg")';
    }
}

let servePosition = localStorage.getItem('servePosition') || 'top';
let statsPlayer1 = JSON.parse(localStorage.getItem('statsPlayer1')) || {};
let statsPlayer2 = JSON.parse(localStorage.getItem('statsPlayer2')) || {};





function initializeMatch(matchData) {
    if (!matchData.scores) matchData.scores = { player1: [0], player2: [0] };
    if (matchData.currentSet == null) matchData.currentSet = 0;
    if (!matchData.currentGameScore) matchData.currentGameScore = { player1: '0', player2: '0' };
    if (!matchData.gameHistory) matchData.gameHistory = [[]];
    if (!matchData.inTiebreak) matchData.inTiebreak = false;
}

function resetCurrentGameScore(matchData) {
    matchData.currentGameScore = { player1: '0', player2: '0' };
}

function finishTiebreak(matchData, winner) {
    const setIndex = matchData.currentSet;

    if (winner === 'player1') {
        matchData.scores.player1[setIndex] = 7;
        matchData.scores.player2[setIndex] = 6;
    } else {
        matchData.scores.player1[setIndex] = 6;
        matchData.scores.player2[setIndex] = 7;
    }

    matchData.currentSet++;
    matchData.inTiebreak = false;
    matchData.tiebreakScore = { player1: 0, player2: 0 };
    matchData.scores.player1[matchData.currentSet] = 0;
    matchData.scores.player2[matchData.currentSet] = 0;

    resetCurrentGameScore(matchData);

    // Νέο game history για το επόμενο σετ
    matchData.gameHistory[matchData.currentSet] = [];
}


function winGame(playerKey, matchData) {
    initializeMatch(matchData);
    const setIndex = matchData.currentSet;

    if (!matchData.inTiebreak) {
        matchData.scores[playerKey][setIndex]++;
        const pGames = matchData.scores.player1[setIndex];
        const oGames = matchData.scores.player2[setIndex];

        if (pGames === 6 && oGames === 6) {
            matchData.inTiebreak = true;
            matchData.tiebreakScore = { player1: 0, player2: 0 };
            resetCurrentGameScore(matchData);
        } else if ((pGames >= 6 || oGames >= 6) && Math.abs(pGames - oGames) >= 2) {
            matchData.currentSet++;
            matchData.inTiebreak = false;
            matchData.tiebreakScore = { player1: 0, player2: 0 };
            matchData.scores.player1[matchData.currentSet] = 0;
            matchData.scores.player2[matchData.currentSet] = 0;
            resetCurrentGameScore(matchData);
        }
    } else {
        const tP = matchData.tiebreakScore.player1;
        const tO = matchData.tiebreakScore.player2;
        if ((tP >= 7 && tP - tO >= 2) || (tO >= 7 && tO - tP >= 2)) {
            finishTiebreak(matchData, playerKey);
        }
    }

    // **Καταργούμε την καταγραφή του currentGameScore εδώ**
    // matchData.gameHistory[setIndex].push([`${matchData.currentGameScore.player1}-${matchData.currentGameScore.player2}`]);

    resetCurrentGameScore(matchData);

    servePosition = servePosition === 'top' ? 'bottom' : 'top';
    localStorage.setItem('servePosition', servePosition);

    localStorage.setItem('currentMatch', JSON.stringify(matchData));
    renderScoreboard(matchData);
    renderGameHistory(matchData);
}




function addPointTo(playerKey, matchData) {
    initializeMatch(matchData);
    const otherPlayer = playerKey === 'player1' ? 'player2' : 'player1';
    const setIndex = matchData.currentSet;

    if (!matchData.gameHistory[setIndex]) matchData.gameHistory[setIndex] = [];

    // Δημιουργούμε νέο array μόνο αν δεν υπάρχει κανένα game στο σετ
    if (matchData.gameHistory[setIndex].length === 0) {
        matchData.gameHistory[setIndex].push([]);
    }

    const currentGameHistory = matchData.gameHistory[setIndex][matchData.gameHistory[setIndex].length - 1];

    if (matchData.inTiebreak) {
        matchData.currentGameScore[playerKey] = String(Number(matchData.currentGameScore[playerKey] || 0) + 1);
        const pPoints = Number(matchData.currentGameScore.player1);
        const oPoints = Number(matchData.currentGameScore.player2);

        currentGameHistory.push(`${pPoints}-${oPoints}`);

        if ((pPoints >= 7 && pPoints - oPoints >= 2) || (oPoints >= 7 && oPoints - pPoints >= 2)) {
            finishTiebreak(matchData, playerKey);
            // Μετά το finishTiebreak, το reset θα δημιουργήσει νέο array στο επόμενο addPointTo
        }
    } else {
        const scoreMap = ['0','15','30','40'];
        let pScore = matchData.currentGameScore[playerKey];
        let oScore = matchData.currentGameScore[otherPlayer];

        if (pScore === 'Ad') {
            winGame(playerKey, matchData);
            // Δημιουργούμε νέο array για το επόμενο game
            matchData.gameHistory[setIndex].push([]);
        } else if (oScore === 'Ad') {
            matchData.currentGameScore[playerKey] = '40';
            matchData.currentGameScore[otherPlayer] = '40';
            currentGameHistory.push(`${matchData.currentGameScore.player1}-${matchData.currentGameScore.player2}`);
        } else if (pScore === '40' && oScore === '40') {
            matchData.currentGameScore[playerKey] = 'Ad';
            currentGameHistory.push(`${matchData.currentGameScore.player1}-${matchData.currentGameScore.player2}`);
        } else {
            let idx = scoreMap.indexOf(pScore);
            if (idx < scoreMap.length - 1) {
                matchData.currentGameScore[playerKey] = scoreMap[idx + 1];
                currentGameHistory.push(`${matchData.currentGameScore.player1}-${matchData.currentGameScore.player2}`);
            } else {
                winGame(playerKey, matchData);
                if (matchData.currentSet === setIndex) {
                matchData.gameHistory[setIndex].push([]);
         }
            }
        }
    }

    localStorage.setItem('currentMatch', JSON.stringify(matchData));
    renderScoreboard(matchData);
    renderGameHistory(matchData);
}




let openSets = new Set(); // θα κρατάει ποια σετ είναι ανοιχτά

function renderGameHistory(matchData) {
    const container = document.getElementById('gameHistory');

    let header = container.querySelector('h3');
    if (!header) {
        header = document.createElement('h3');
        header.textContent = 'Ιστορικό Game';
        container.appendChild(header);
    }

    // Καθαρίζουμε παλιά sets
    Array.from(container.children).forEach(child => {
        if (child !== header) container.removeChild(child);
    });

    matchData.gameHistory.forEach((setGames, setIndex) => {
        const setDiv = document.createElement('div');
        setDiv.className = 'set-history';

        // Τίτλος σετ
        const setTitle = document.createElement('strong');
        setTitle.textContent = `Set ${setIndex + 1}`;
        setDiv.appendChild(setTitle);

        // Κουμπί toggle
        const toggleButton = document.createElement('button');
        toggleButton.className = 'toggle-button';
        toggleButton.textContent = 'Προβολή Games ▼';
        setDiv.appendChild(toggleButton);

        // Container για games
        const gamesContainer = document.createElement('div');
        gamesContainer.className = 'games-container';

        setGames.forEach((gameScores, gameIndex) => {
            const gameDiv = document.createElement('div');
            gameDiv.className = 'game-score-history';
            gameDiv.textContent = `Game ${gameIndex + 1}: ${gameScores.join(', ')}`;
            gamesContainer.appendChild(gameDiv);
        });

        setDiv.appendChild(gamesContainer);
        container.appendChild(setDiv);

        // Αν το σετ ήταν ήδη ανοιχτό, ξανανοίγουμε
        if (openSets.has(setIndex)) {
            gamesContainer.style.maxHeight = gamesContainer.scrollHeight + 'px';
            toggleButton.textContent = 'Απόκρυψη Games ▲';
        }

        // Toggle λειτουργία
        toggleButton.addEventListener('click', () => {
            if (gamesContainer.style.maxHeight && gamesContainer.style.maxHeight !== '0px') {
                gamesContainer.style.maxHeight = '0px';
                toggleButton.textContent = 'Προβολή Games ▼';
                openSets.delete(setIndex);
            } else {
                gamesContainer.style.maxHeight = gamesContainer.scrollHeight + 'px';
                toggleButton.textContent = 'Απόκρυψη Games ▲';
                openSets.add(setIndex);
            }
        });
    });
}









  function renderScoreboard(matchData) {
    const container = document.getElementById('wimbledonScoreboard');
    container.innerHTML = '';

    const sets = 3; // πάντα 3 σετ για εμφάνιση
    const player1 = matchData.player1.lastName.toUpperCase();
    const player2 = matchData.player2.lastName.toUpperCase();

    document.getElementById('player1-name').textContent = player1;
    document.getElementById('player2-name').textContent = player2;

    // Αν δεν υπάρχουν scores, γεμίζουμε με 0 και πάντα 3 σετ
    const scores1 = matchData.scores?.player1 || [];
    const scores2 = matchData.scores?.player2 || [];
    while (scores1.length < sets) scores1.push(0);
    while (scores2.length < sets) scores2.push(0);

    const currentGameScore = matchData.currentGameScore || { player1: '0', player2: '0' };
    const serveState = JSON.parse(localStorage.getItem('serveState')) || { player1: { pendingFault: false }, player2: { pendingFault: false } };

    const createPlayerRow = (name, scores, gameScore, isServing, playerKey) => {
        const row = document.createElement('div');
        row.className = 'scoreboard-row';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'player-name';
        nameDiv.textContent = name;
        row.appendChild(nameDiv);

        const setsContainer = document.createElement('div');
        setsContainer.className = 'sets-container';
        scores.forEach(score => {
            const scoreBox = document.createElement('div');
            scoreBox.className = 'set-score';
            scoreBox.textContent = score;
            setsContainer.appendChild(scoreBox);
        });
        row.appendChild(setsContainer);

        const gameScoreContainer = document.createElement('div');
        gameScoreContainer.className = 'game-score-container';

        const gameScoreDiv = document.createElement('div');
        gameScoreDiv.className = 'game-score';
        gameScoreDiv.textContent = gameScore;
        gameScoreContainer.appendChild(gameScoreDiv);

        if (isServing) {
            const serveButton1 = document.createElement('button');
            serveButton1.id = `serveButton1-${playerKey}`;
            serveButton1.className = 'serve-ball';
            serveButton1.textContent = '🎾';
            serveButton1.title = 'Αλλαγή σερβίς';
            serveButton1.onclick = () => {
                servePosition = servePosition === 'top' ? 'bottom' : 'top';
                renderScoreboard(matchData);
                renderActionButtons();
            };

            const serveButton2 = document.createElement('button');
            serveButton2.id = `serveButton2-${playerKey}`;
            serveButton2.className = 'serve-ball extra';
            serveButton2.textContent = '🎾';
            serveButton2.title = 'Δεύτερο μπαλάκι';
            serveButton2.style.display = 'inline';

            if (serveState[playerKey] && serveState[playerKey].pendingFault) {
                serveButton2.style.display = 'none';
            }

            gameScoreContainer.appendChild(serveButton1);
            gameScoreContainer.appendChild(serveButton2);
        }

        row.appendChild(gameScoreContainer);
        return row;
    };

    const row1 = createPlayerRow(player1, scores1, currentGameScore.player1, servePosition === 'top', 'player1');
    const row2 = createPlayerRow(player2, scores2, currentGameScore.player2, servePosition === 'bottom', 'player2');

    container.appendChild(row1);
    container.appendChild(row2);

    renderActionButtons();
}


  function renderActionButtons() {
    const player1Btns = document.getElementById('player1-buttons');
    const player2Btns = document.getElementById('player2-buttons');

    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    const p1Name = matchData.player1?.lastName?.toUpperCase() || 'ΠΑΙΚΤΗΣ 1';
    const p2Name = matchData.player2?.lastName?.toUpperCase() || 'ΠΑΙΚΤΗΣ 2';

    document.getElementById('player1-name').textContent = p1Name;
    document.getElementById('player2-name').textContent = p2Name;

    player1Btns.innerHTML = '';
    player2Btns.innerHTML = '';

    const serveActions = ['Ace', 'Ball In', 'Fault'];
    const returnActions = ['Return Winner', 'Return Error'];
    const extraActions = ['Winner', 'Unforced Error', 'Forced Error'];

    // Βάζουμε/διαβάζουμε global serveState (στο localStorage για persistence)
    const defaultServeState = { player1: { pendingFault: false }, player2: { pendingFault: false } };
    const serveState = JSON.parse(localStorage.getItem('serveState')) || defaultServeState;

    const createButton = (action, playerLabel, container, group) => {
      const btn = document.createElement('button');
      btn.className = 'action-btn';
      btn.textContent = action;
      btn.dataset.group = group;
      btn.dataset.action = action;

      // προσδιοριζουμε playerKey από container id
      const playerKey = container.id === 'player1-buttons' ? 'player1' : 'player2';
      btn.dataset.playerKey = playerKey;

      // αρχική εμφάνιση: αν υπάρχει pending fault για αυτόν
      if (action === 'Fault' && serveState[playerKey] && serveState[playerKey].pendingFault) {
        btn.style.backgroundColor = 'red';
        btn.textContent = 'Double Fault';
        btn.classList.add('fault-active');
      }
if (action === 'Ace') {
  btn.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    const playerKey = btn.dataset.playerKey;
    const statsKey = playerKey === 'player1' ? 'statsPlayer1' : 'statsPlayer2';
    let stats = JSON.parse(localStorage.getItem(statsKey)) || {};

    // Αύξηση Άσσων
    stats['Άσοι'] = (stats['Άσοι'] || 0) + 1;

    // Αύξηση Νικητών
    stats['Νικητές'] = (stats['Νικητές'] || 0) + 1;

    // Αύξηση Κερδισμένων Πόντων
    stats['Κερδισμένοι Πόντοι'] = (stats['Κερδισμένοι Πόντοι'] || 0) + 1;

    // Αύξηση Πόντων με Σερβίς
    stats['Πόντοι με σερβίς'] = (stats['Πόντοι με σερβίς'] || 0) + 1;

    // Έλεγχος πρώτου σερβίς
    const serveState = JSON.parse(localStorage.getItem('serveState')) || {};
    if (!serveState[playerKey]) serveState[playerKey] = { pendingFault: false };

    if (!serveState[playerKey].pendingFault) {
      stats.firstServeNumerator = (stats.firstServeNumerator || 0) + 1;
      stats.firstServeDenominator = (stats.firstServeDenominator || 0) + 1;
    } else {
      serveState[playerKey].pendingFault = false;
      localStorage.setItem('serveState', JSON.stringify(serveState));
    }

    // Υπολογισμός ποσοστού 1ου σερβίς
    const num = stats.firstServeNumerator || 0;
    const denom = stats.firstServeDenominator || 0;
    const percent = denom > 0 ? Math.round((num / denom) * 100) : 0;
    stats['Ποσοστό 1ου σερβίς'] = `${num}/${denom} (${percent}%)`;

    localStorage.setItem(statsKey, JSON.stringify(stats));

    // Προσθήκη πόντου
    addPointTo(playerKey, matchData);

    // Ενημέρωση UI
    renderScoreboard(matchData);
    renderActionButtons();
  });
}


    if (action === 'Fault') {
  btn.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    const playerKey = btn.dataset.playerKey;
    const statsKey = playerKey === 'player1' ? 'statsPlayer1' : 'statsPlayer2';
    let stats = JSON.parse(localStorage.getItem(statsKey)) || {};

    // Αρχικοποίηση
    stats.firstServeNumerator = stats.firstServeNumerator || 0;
    stats.firstServeDenominator = stats.firstServeDenominator || 0;
    stats['Νταμπλ φολτ'] = stats['Νταμπλ φολτ'] || 0;

    const serveState = JSON.parse(localStorage.getItem('serveState')) || {};
    if (!serveState[playerKey]) serveState[playerKey] = { pendingFault: false };

    if (!serveState[playerKey].pendingFault) {
      // Πρώτο fault → μόνο ενημέρωση πρώτου σερβίς
      serveState[playerKey].pendingFault = true;
      stats.firstServeDenominator += 1;

      const num = stats.firstServeNumerator;
      const denom = stats.firstServeDenominator;
      const percent = denom > 0 ? Math.round((num / denom) * 100) : 0;
      stats['Ποσοστό 1ου σερβίς'] = `${num}/${denom} (${percent}%)`;

      localStorage.setItem(statsKey, JSON.stringify(stats));
      localStorage.setItem('serveState', JSON.stringify(serveState));

      renderScoreboard(matchData);
      renderActionButtons();

    } else {
      // Δεύτερο fault → Double Fault
      stats['Νταμπλ φολτ'] += 1;
      stats['Ατομικά λάθη'] = (stats['Ατομικά λάθη'] || 0) + 1;

      const opponentKey = playerKey === 'player1' ? 'player2' : 'player1';
      const opponentStatsKey = opponentKey === 'player1' ? 'statsPlayer1' : 'statsPlayer2';
      let opponentStats = JSON.parse(localStorage.getItem(opponentStatsKey)) || {};

      // Αυξάνουμε Πόντους χωρίς σερβίς και Κερδισμένους πόντους για τον αντίπαλο
      opponentStats['Πόντοι χωρίς σερβίς'] = (opponentStats['Πόντοι χωρίς σερβίς'] || 0) + 1;
      opponentStats['Κερδισμένοι Πόντοι'] = (opponentStats['Κερδισμένοι Πόντοι'] || 0) + 1;

      localStorage.setItem(statsKey, JSON.stringify(stats));
      localStorage.setItem(opponentStatsKey, JSON.stringify(opponentStats));

      addPointTo(opponentKey, matchData);

      serveState[playerKey].pendingFault = false;
      localStorage.setItem('serveState', JSON.stringify(serveState));

      renderScoreboard(matchData);
      renderActionButtons();
    }
  });

  container.appendChild(btn);
  return;
}



if (action === 'Ball In') {
  btn.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    const statsKey = playerKey === 'player1' ? 'statsPlayer1' : 'statsPlayer2';
    let stats = JSON.parse(localStorage.getItem(statsKey)) || {};

    stats.firstServeNumerator = stats.firstServeNumerator || 0;
    stats.firstServeDenominator = stats.firstServeDenominator || 0;

    const curServeState = JSON.parse(localStorage.getItem('serveState')) || defaultServeState;

    if (curServeState[playerKey] && curServeState[playerKey].pendingFault) {
      curServeState[playerKey].pendingFault = false;
      localStorage.setItem('serveState', JSON.stringify(curServeState));

      // Επαναφορά κουμπιού Fault
      const faultBtn = container.querySelector('[data-action="Fault"]');
      if (faultBtn) {
        faultBtn.style.backgroundColor = '#006400';
        faultBtn.textContent = 'Fault';
        faultBtn.classList.remove('fault-active');
      }

      // Επαναφορά δεύτερου μπαλακιού
      const sb2 = document.getElementById(`serveButton2-${playerKey}`);
      if (sb2) sb2.style.display = 'inline';

    } else {
      stats.firstServeNumerator += 1;
      stats.firstServeDenominator += 1;

      const num = stats.firstServeNumerator;
      const denom = stats.firstServeDenominator;
      const percent = denom > 0 ? Math.round((num / denom) * 100) : 0;
      stats['Ποσοστό 1ου σερβίς'] = `(${num}/${denom}) ${percent}%`;

      localStorage.setItem(statsKey, JSON.stringify(stats));
    }

    toggleActionGroups(false, 'main');
    toggleActionGroups(true, 'extra');
  });

  container.appendChild(btn);
  return;
}


if (action === 'Return Error' || action === 'Return Winner') {
  btn.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    const playerKey = btn.dataset.playerKey; // ο παίκτης που πατάει το κουμπί
    const opponentKey = playerKey === 'player1' ? 'player2' : 'player1';

    // stats του παίκτη που πατάει το κουμπί
    const statsKey = playerKey === 'player1' ? 'statsPlayer1' : 'statsPlayer2';
    let stats = JSON.parse(localStorage.getItem(statsKey)) || {};

    // stats του αντίπαλου
    const opponentStatsKey = opponentKey === 'player1' ? 'statsPlayer1' : 'statsPlayer2';
    let opponentStats = JSON.parse(localStorage.getItem(opponentStatsKey)) || {};

    // serve state
    const serveState = JSON.parse(localStorage.getItem('serveState')) || {};
    if (!serveState[opponentKey]) serveState[opponentKey] = { pendingFault: false };

    // Αν είναι πρώτο σερβίς (πράσινο Fault)
    if (!serveState[opponentKey].pendingFault) {
      opponentStats.firstServeDenominator = (opponentStats.firstServeDenominator || 0) + 1;
      opponentStats.firstServeNumerator = (opponentStats.firstServeNumerator || 0) + 1;

      const num = opponentStats.firstServeNumerator;
      const denom = opponentStats.firstServeDenominator;
      const percent = denom > 0 ? Math.round((num / denom) * 100) : 0;
      opponentStats['Ποσοστό 1ου σερβίς'] = `${num}/${denom} (${percent}%)`;

      localStorage.setItem(opponentStatsKey, JSON.stringify(opponentStats));
    }

    if (action === 'Return Winner') {
      // αυξάνει stats του παίκτη
      stats['Return Winners'] = (stats['Return Winners'] || 0) + 1;
      stats['Νικητές'] = (stats['Νικητές'] || 0) + 1;
      stats['Πόντοι χωρίς σερβίς'] = (stats['Πόντοι χωρίς σερβίς'] || 0) + 1;
      stats['Κερδισμένοι Πόντοι'] = (stats['Κερδισμένοι Πόντοι'] || 0) + 1;

      addPointTo(playerKey, matchData);
    } else if (action === 'Return Error') {
      // αυξάνει stats του αντίπαλου
      stats['Return Errors'] = (stats['Return Errors'] || 0) + 1;
      stats['Ατομικά λάθη'] = (stats['Ατομικά λάθη'] || 0) + 1;
      opponentStats['Πόντοι με σερβίς'] = (opponentStats['Πόντοι με σερβίς'] || 0) + 1;
      opponentStats['Κερδισμένοι Πόντοι'] = (opponentStats['Κερδισμένοι Πόντοι'] || 0) + 1;

      addPointTo(opponentKey, matchData);
    }

    localStorage.setItem(statsKey, JSON.stringify(stats));
    localStorage.setItem(opponentStatsKey, JSON.stringify(opponentStats));
    localStorage.setItem('currentMatch', JSON.stringify(matchData));
    localStorage.setItem('serveState', JSON.stringify(serveState));

    resetFaultButtons();
    renderScoreboard(matchData);
    renderActionButtons();
  });
}



 // default click behaviour για υπόλοιπα
      btn.addEventListener('click', () => {
        if (action === 'Ball In') {
          toggleActionGroups(false, 'main');
          toggleActionGroups(true, 'extra');
          
        }

        if (group === 'extra') {
          toggleActionGroups(true, 'main');
          toggleActionGroups(false, 'extra');
        }
      });
     

      container.appendChild(btn);
    };

    function toggleActionGroups(show, group) {
      const buttons = document.querySelectorAll(`[data-group]`);
      buttons.forEach(btn => {
        if (btn.dataset.group === group) {
          btn.style.display = show ? 'flex' : 'none';
        }
      });
    }

    // Δημιουργία βασικών κουμπιών ανάλογα με τη θέση σερβίς
    if (servePosition === 'top') {
      serveActions.forEach(action => createButton(action, p1Name, player1Btns, 'main'));
      returnActions.forEach(action => createButton(action, p2Name, player2Btns, 'main'));
    } else {
      serveActions.forEach(action => createButton(action, p2Name, player2Btns, 'main'));
      returnActions.forEach(action => createButton(action, p1Name, player1Btns, 'main'));
    }

    // extra actions (σώζονται και για τους δύο παίκτες)
   // extra actions (Winner, Unforced Error, Forced Error)
extraActions.forEach(action => {
  // --- Κουμπί για Player1 ---
  const btn1 = document.createElement('button');
  btn1.className = 'action-btn';
  btn1.textContent = action;
  btn1.dataset.group = 'extra';
  btn1.dataset.action = action;
  btn1.dataset.playerKey = 'player1';
  btn1.style.display = 'none';

 if (action === 'Winner') {
  btn1.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    let stats = JSON.parse(localStorage.getItem('statsPlayer1')) || {};

    // Αύξηση νικητών και κερδισμένων πόντων πάντα
    stats['Νικητές'] = (stats['Νικητές'] || 0) + 1;
    stats['Κερδισμένοι Πόντοι'] = (stats['Κερδισμένοι Πόντοι'] || 0) + 1;

    // Αν σερβίρει ο player2, αυξάνονται μόνο οι πόντοι (χωρίς σερβίς)
    if (servePosition=='bottom') {
       stats['Πόντοι χωρίς σερβίς'] = (stats['Πόντοι χωρίς σερβίς'] || 0) + 1;
    }
 if (servePosition=='top')  {
       stats['Πόντοι με σερβίς'] = (stats['Πόντοι με σερβίς'] || 0) + 1;
    }
    localStorage.setItem('statsPlayer1', JSON.stringify(stats));

    // Προσθήκη πόντου στον παίκτη1 στο matchData
    addPointTo('player1', matchData);
    localStorage.setItem('currentMatch', JSON.stringify(matchData));

    renderScoreboard(matchData);
    renderActionButtons();
  });
}



  if (action === 'Unforced Error' || action === 'Forced Error') {
  btn1.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    let stats1 = JSON.parse(localStorage.getItem('statsPlayer1')) || {};
    let stats2 = JSON.parse(localStorage.getItem('statsPlayer2')) || {};

    // Αύξηση λαθών για Player1
    if (action === 'Unforced Error') {
      stats1['Ατομικά λάθη'] = (stats1['Ατομικά λάθη'] || 0) + 1;
    } else if (action === 'Forced Error') {
      stats1['Λάθη υπό πίεση'] = (stats1['Λάθη υπό πίεση'] || 0) + 1;
    }

    // Προσθήκη πόντου στον αντίπαλο
   

    // Αύξηση "Κερδισμένων Πόντων" για Player2
    stats2['Κερδισμένοι Πόντοι'] = (stats2['Κερδισμένοι Πόντοι'] || 0) + 1;

    // Αύξηση πόντων με/χωρίς σερβίς ανάλογα με το ποιος σερβίρει
    if (servePosition === 'bottom') {
      stats2['Πόντοι με σερβίς'] = (stats2['Πόντοι με σερβίς'] || 0) + 1;
    } else if (servePosition === 'top') {
      stats2['Πόντοι χωρίς σερβίς'] = (stats2['Πόντοι χωρίς σερβίς'] || 0) + 1;
    }
addPointTo('player2', matchData)
    // Αποθήκευση
    localStorage.setItem('statsPlayer1', JSON.stringify(stats1));
    localStorage.setItem('statsPlayer2', JSON.stringify(stats2));
    localStorage.setItem('currentMatch', JSON.stringify(matchData));

    renderScoreboard(matchData);
    renderActionButtons();
  });
}



  player1Btns.appendChild(btn1);

  // --- Κουμπί για Player2 ---
  const btn2 = document.createElement('button');
  btn2.className = 'action-btn';
  btn2.textContent = action;
  btn2.dataset.group = 'extra';
  btn2.dataset.action = action;
  btn2.dataset.playerKey = 'player2';
  btn2.style.display = 'none';

  
if (action === 'Winner') {
  btn2.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    let stats = JSON.parse(localStorage.getItem('statsPlayer2')) || {};

    // Αύξηση νικητών και κερδισμένων πόντων πάντα
    stats['Νικητές'] = (stats['Νικητές'] || 0) + 1;
    stats['Κερδισμένοι Πόντοι'] = (stats['Κερδισμένοι Πόντοι'] || 0) + 1;

    // Αν σερβίρει ο player1, αυξάνονται μόνο οι πόντοι χωρίς σερβίς
   if (servePosition=='top')  {
       stats['Πόντοι χωρίς σερβίς'] = (stats['Πόντοι χωρίς σερβίς'] || 0) + 1;
    }
 if (servePosition=='bottom')  {
       stats['Πόντοι με σερβίς'] = (stats['Πόντοι με σερβίς'] || 0) + 1;
    }
    localStorage.setItem('statsPlayer2', JSON.stringify(stats));

    // Προσθήκη πόντου στον player2 στο matchData
    addPointTo('player2', matchData);
    localStorage.setItem('currentMatch', JSON.stringify(matchData));

    renderScoreboard(matchData);
    renderActionButtons();
  });
}

if (action === 'Unforced Error' || action === 'Forced Error') {
  btn2.addEventListener('click', () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    let stats2 = JSON.parse(localStorage.getItem('statsPlayer2')) || {};
    let stats1 = JSON.parse(localStorage.getItem('statsPlayer1')) || {};

    // Αύξηση λαθών για Player2
    if (action === 'Unforced Error') {
      stats2['Ατομικά λάθη'] = (stats2['Ατομικά λάθη'] || 0) + 1;
    } else if (action === 'Forced Error') {
      stats2['Λάθη υπό πίεση'] = (stats2['Λάθη υπό πίεση'] || 0) + 1;
    }

    // Προσθήκη πόντου στον αντίπαλο
    

    // Αύξηση "Κερδισμένων Πόντων" για Player1
    stats1['Κερδισμένοι Πόντοι'] = (stats1['Κερδισμένοι Πόντοι'] || 0) + 1;

    // Αύξηση πόντων με/χωρίς σερβίς ανάλογα με το ποιος σερβίρει
    if (servePosition === 'top') {
      stats1['Πόντοι με σερβίς'] = (stats1['Πόντοι με σερβίς'] || 0) + 1;
    } else if (servePosition === 'bottom') {
      stats1['Πόντοι χωρίς σερβίς'] = (stats1['Πόντοι χωρίς σερβίς'] || 0) + 1;
    }
addPointTo('player1', matchData);
    // Αποθήκευση
    localStorage.setItem('statsPlayer2', JSON.stringify(stats2));
    localStorage.setItem('statsPlayer1', JSON.stringify(stats1));
    localStorage.setItem('currentMatch', JSON.stringify(matchData));

    renderScoreboard(matchData);
    renderActionButtons();
  });
}




  player2Btns.appendChild(btn2);
});

  }

  function toggleSecondBall(show = true) {
    const ball1 = document.getElementById('serveButton2-player1');
    const ball2 = document.getElementById('serveButton2-player2');
    if (ball1) ball1.style.display = show ? 'inline' : 'none';
    if (ball2) ball2.style.display = show ? 'inline' : 'none';
  }

  window.onload = () => {
    const matchData = JSON.parse(localStorage.getItem('currentMatch'));
    if (!matchData) {
      document.body.innerHTML = '<p style="color: red;">Δεν υπάρχουν δεδομένα αγώνα.</p>';
      return;
    }

    document.getElementById('tournamentInfo').innerHTML = `
      <h1 style="color: #ffc371;">${matchData.tournament}</h1>
      <p style="color: #fff; font-size: 1.5rem; font-weight: 500; text-shadow: 0 1px 2px #000;">
        📍 ${matchData.location} | 🗓 ${matchData.date} | 🕒 ${matchData.time}
      </p>
    `;

    updateCourtImage(matchData.rules.courtType);
    renderScoreboard(matchData);
  };
  function updateStat(playerKey, category, isWon = true) {
  let stats = JSON.parse(localStorage.getItem(playerKey)) || createEmptyStats();
  stats = normalizeStats(stats);

  // Αν είναι μετρητής "won/total"
  if (stats[category] && typeof stats[category] === "object") {
    if (isWon) stats[category].won++;
    stats[category].total++;
  } else {
    // Απλή αριθμητική κατηγορία (π.χ. Άσοι)
    stats[category] = (Number(stats[category]) || 0) + 1;
  }

  localStorage.setItem(playerKey, JSON.stringify(stats));
  loadStats(); // ανανέωση του πίνακα
}

function toggleServer() {
  const serveState = JSON.parse(localStorage.getItem('serveState')) || {};
  const current = serveState.currentServer || 'player1';
  const newServer = current === 'player1' ? 'player2' : 'player1';
  serveState.currentServer = newServer;
  serveState.servePosition = newServer === 'player1' ? 'top' : 'bottom';
  
  renderScoreboard(JSON.parse(localStorage.getItem('currentMatch')));
  localStorage.setItem('servePosition', servePosition);  // <--- προσθήκη
}

document.getElementById('saveMatchButton').addEventListener('click', () => {
    // Παίρνουμε τα δεδομένα του τρέχοντος αγώνα
    const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
    const statsPlayer1 = JSON.parse(localStorage.getItem('statsPlayer1')) || {};
    const statsPlayer2 = JSON.parse(localStorage.getItem('statsPlayer2')) || {};

    if (!matchData.player1 || !matchData.player2) {
        alert('Δεν έχει οριστεί πλήρως ο αγώνας.');
        return;
    }

    // Δημιουργία αντικειμένου για αποθήκευση
    const savedMatch = {
        date: new Date().toISOString(),
        players: {
            player1: matchData.player1.lastName,
            player2: matchData.player2.lastName
        },
        scores: matchData.scores,
        gameHistory: matchData.gameHistory,
        stats: {
            player1: statsPlayer1,
            player2: statsPlayer2
        }
    };

    // Παίρνουμε τα προηγούμενα παιχνίδια από το ίδιο key που χρησιμοποιεί η live.html
    const savedMatches = JSON.parse(localStorage.getItem('savedMatches')) || [];

    // Προσθέτουμε τον νέο αγώνα
    savedMatches.push(savedMatch);

    // Αποθηκεύουμε πίσω στο localStorage
    localStorage.setItem('savedMatches', JSON.stringify(savedMatches));

    alert('Ο αγώνας αποθηκεύτηκε επιτυχώς και είναι διαθέσιμος στη live σελίδα!');
});
function resetFaultButtons() { //επαναφορα κουμπιου fault
  const serveState = JSON.parse(localStorage.getItem('serveState')) || {};
  serveState.player1.pendingFault = false;
  serveState.player2.pendingFault = false;
  localStorage.setItem('serveState', JSON.stringify(serveState));

  ['player1', 'player2'].forEach(playerKey => {
    const btn = document.querySelector(`#${playerKey}-buttons button[data-action="Fault"]`);
    if (btn) {
      btn.style.backgroundColor = 'green'; // αρχικό πράσινο
      btn.textContent = 'Fault';
      btn.classList.remove('fault-active');
    }
  });

  // Ανανεώνουμε UI
  const matchData = JSON.parse(localStorage.getItem('currentMatch')) || {};
  renderScoreboard(matchData);
  renderActionButtons();
}

</script>

</body>
</html>
